---
import { getRelativeLocaleUrl } from 'astro:i18n'
import { useTranslations } from '../../i18n/ui'

const lang = Astro.currentLocale as string
const t = useTranslations(lang)
---

<div id="search-container" class="relative">
  <!-- Search Icon Button -->
  <button
    id="search-toggle"
    type="button"
    class="group relative flex gap-1 text-lg font-bold uppercase transition-opacity hover:opacity-80"
    aria-label={t('search.ariaLabel')}
  >
    <span class="absolute -right-2 -top-2 hidden h-2 w-2 rounded-full bg-vanille group-hover:block" />
    <i class="icon-search" />
  </button>

  <!-- Search Dropdown -->
  <div
    id="search-dropdown"
    class="absolute right-0 top-full z-50 mt-4 hidden w-96 max-w-[calc(100vw-2rem)] rounded-lg border border-black bg-vanille shadow-lg"
  >
    <!-- Search Input -->
    <div class="border-b border-black p-4">
      <form id="search-form" class="flex gap-2">
        <input
          type="text"
          id="search-input"
          name="q"
          placeholder={t('search.placeholder')}
          class="flex-1 rounded border border-black bg-white px-3 py-2 text-sm text-black placeholder:text-black/50 focus:border-black focus:outline-none"
          autocomplete="off"
        />
        <button
          type="submit"
          id="search-submit-btn"
          class="relative flex min-w-[100px] items-center justify-center rounded bg-black px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-black/90 disabled:cursor-wait disabled:hover:bg-black"
        >
          <span id="search-submit-text" class="block">{t('search.submit')}</span>
          <div id="search-submit-spinner" class="hidden absolute inset-0 flex items-center justify-center">
            <div class="search-spinner-custom">
              <div class="spinner-dot"></div>
              <div class="spinner-dot"></div>
              <div class="spinner-dot"></div>
            </div>
          </div>
        </button>
      </form>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="max-h-96 overflow-y-auto p-4">
      <div id="search-placeholder" class="text-center text-sm text-black/70">
        {t('search.results.placeholder')}
      </div>
      <div id="search-loading" class="hidden text-center text-sm text-black/70">
        {t('search.loading')}
      </div>
      <div id="search-empty" class="hidden text-center text-sm text-black/70">
        {t('search.results.empty')}
      </div>
      <div id="search-error" class="hidden text-center text-sm text-red-700">
        {t('search.error')}
      </div>
      <div id="search-results-list" class="hidden flex flex-col gap-4"></div>
    </div>
  </div>
</div>

<script>
  import { initializeSearch, resetSearchState, type SearchElements } from '../../utils/search'

  const lang = '${lang}'
  const searchContainer = document.getElementById('search-container')
  const searchToggle = document.getElementById('search-toggle')
  const searchDropdown = document.getElementById('search-dropdown')
  const searchForm = document.getElementById('search-form')
  const searchInput = document.getElementById('search-input')
  const searchSubmitBtn = document.getElementById('search-submit-btn')
  const searchSubmitText = document.getElementById('search-submit-text')
  const searchSubmitSpinner = document.getElementById('search-submit-spinner')
  const searchPlaceholder = document.getElementById('search-placeholder')
  const searchLoading = document.getElementById('search-loading')
  const searchEmpty = document.getElementById('search-empty')
  const searchError = document.getElementById('search-error')
  const searchResultsList = document.getElementById('search-results-list')

  let isOpen = false

  // Initialize search functionality
  const searchElements: SearchElements = {
    form: searchForm as HTMLFormElement,
    input: searchInput as HTMLInputElement,
    submitBtn: searchSubmitBtn as HTMLButtonElement,
    submitText: searchSubmitText,
    submitSpinner: searchSubmitSpinner,
    placeholder: searchPlaceholder,
    loading: searchLoading,
    empty: searchEmpty,
    error: searchError,
    resultsList: searchResultsList
  }

  initializeSearch({
    lang: lang as string,
    elements: searchElements,
    renderOptions: {
      borderWidth: 'border'
    }
  })

  // Toggle search dropdown
  searchToggle?.addEventListener('click', (e) => {
    e.stopPropagation()
    isOpen = !isOpen
    if (isOpen) {
      searchDropdown?.classList.remove('hidden')
      searchInput?.focus()
      // Reset to initial state
      resetSearchState(searchElements)
    } else {
      searchDropdown?.classList.add('hidden')
    }
  })

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (isOpen && searchContainer && !searchContainer.contains(e.target as Node)) {
      isOpen = false
      searchDropdown?.classList.add('hidden')
    }
  })

  // Close dropdown on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      isOpen = false
      searchDropdown?.classList.add('hidden')
    }
  })
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-spinner-custom {
    display: flex;
    gap: 4px;
    align-items: center;
    justify-content: center;
  }

  .spinner-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: white;
    animation: spinnerPulse 1.4s ease-in-out infinite;
  }

  .spinner-dot:nth-child(1) {
    animation-delay: 0s;
  }

  .spinner-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .spinner-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes spinnerPulse {
    0%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    50% {
      transform: scale(1.2);
      opacity: 1;
    }
  }
</style>

