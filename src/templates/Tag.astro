---
import Grid from '../components/post/grid.astro'
import type { Tag } from '../api/tag'
import { getPostBySlug, getPosts, type Post } from '../api/post'
import { getLangFromUrl, useTranslations } from '../i18n/utils'
import { getPageNumberInUrl } from '../utils/pagination'
import { POSTS_PER_PAGE } from '../constant'
import Pagination from '../components/pagination.astro'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const node: Tag = Astro.props.node

// Handle Pagination & Filters
const page = getPageNumberInUrl(Astro.url)
const filters = `&tags=${node?.id}&per_page=${POSTS_PER_PAGE}&page=${page}`
const postsBySlug = await getPosts(lang, filters)
let posts: Post[] = []
postsBySlug.map(
  async (post) =>
    await getPostBySlug(post.slug, lang).then((post: Post | null) => {
      if (post) posts.push(post)
    })
)
---

<div class="space-y-8">
  <h1 class="text-xl font-bold">{t('tag.grid.title')} {node.name}</h1>
  <Grid posts={posts} />
  <Pagination
    total={node.count}
    perPage={POSTS_PER_PAGE}
    currentPage={page}
    baseUrl={`/tag/${node.slug}`}
  />
</div>
